<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>VixStream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      background: #111;
      color: #eee;
    }
    header, .filters, section {
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    .hero {
      position: relative;
      height: 60vh;
      overflow: hidden;
      color: #fff;
    }
    .hero-backdrop {
      position: absolute;
      inset: 0;
      background-size: cover;
      background-position: center;
      filter: brightness(0.5);
    }
    .hero-content {
      position: relative;
      z-index: 1;
      top: 30%;
      transform: translateY(-30%);
      max-width: 600px;
    }
    .hero h1 {
      font-size: 3rem;
      margin: 0 0 10px;
    }
    .hero p {
      font-size: 1.1rem;
      line-height: 1.4;
      max-height: 3.5em;
      overflow: hidden;
    }
    .hero button {
      margin-top: 15px;
      padding: 10px 20px;
      background: #e50914;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 1rem;
    }
    .filters input, .filters select, .filters button {
      padding: 8px;
      margin-right: 10px;
      margin-bottom: 10px;
      background: #222;
      border: 1px solid #333;
      color: #eee;
    }
    .grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    }
    .card {
      background: #222;
      border-radius: 4px;
      overflow: hidden;
      cursor: pointer;
    }
    .card img {
      width: 100%;
      display: block;
    }
    .card p {
      padding: 8px;
      margin: 0;
      font-size: 0.9rem;
      text-align: center;
    }
    #videoPlayer {
      width: 100%;
      max-width: 800px;
      display: block;
      margin: 20px auto;
      background: #000;
    }
  </style>
</head>
<body>

  <!-- Hero Section -->
  <header class="hero" id="hero">
    <div class="hero-backdrop" id="hero-backdrop"></div>
    <div class="hero-content">
      <h1 id="hero-title">Caricamento...</h1>
      <p id="hero-overview"></p>
      <button id="hero-play">Riproduci</button>
    </div>
  </header>

  <!-- Search & Filters -->
  <div class="filters">
    <input type="text" id="filter-title" placeholder="Titolo" />
    <input type="number" id="filter-year" placeholder="Anno" min="1900" max="2100" />
    <select id="filter-type">
      <option value="all">Tutti i tipi</option>
      <option value="movie">Film</option>
      <option value="tv">Serie TV</option>
    </select>
    <select id="filter-genre">
      <option value="all">Tutti i generi</option>
    </select>
    <button id="filter-button">Cerca</button>
    <div id="searchResults" class="grid"></div>
  </div>

  <!-- Sections -->
  <section>
    <h2>In Tendenza</h2>
    <div id="trendingMovies" class="grid"></div>
  </section>

  <section>
    <h2>I Pi√π Votati</h2>
    <div id="topRatedMovies" class="grid"></div>
  </section>

  <section>
    <h2>Prossime Uscite</h2>
    <div id="upcomingMovies" class="grid"></div>
  </section>

  <section>
    <h2>Serie TV Popolari</h2>
    <div id="popularTv" class="grid"></div>
  </section>

  <!-- Video Player -->
  <video id="videoPlayer" controls></video>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const PROXY_URL = 'https://vixstreamproxy.onrender.com/';
    let available = [];
    let movieGenres = [];
    let tvGenres = [];
    let heroContent = null;

    // load available TMDB IDs
    async function loadAvailable() {
      try {
        const res = await fetch(`${PROXY_URL}home/available`);
        available = await res.json();
      } catch {
        available = [];
      }
    }
    // load genres lists
    async function loadGenres() {
      try {
        const [mv, tv] = await Promise.all([
          fetch(`${PROXY_URL}genre/movie/list`).then(r=>r.json()),
          fetch(`${PROXY_URL}genre/tv/list`).then(r=>r.json())
        ]);
        movieGenres = mv.genres;
        tvGenres = tv.genres;
      } catch {
        movieGenres = [];
        tvGenres = [];
      }
    }
    // populate genre select based on type
    function populateGenres() {
      const select = document.getElementById('filter-genre');
      const type = document.getElementById('filter-type').value;
      select.innerHTML = '<option value="all">Tutti i generi</option>';
      let list = [];
      if (type === 'movie') list = movieGenres;
      else if (type === 'tv') list = tvGenres;
      else list = [...movieGenres, ...tvGenres];
      // remove duplicates by id
      const seen = new Set();
      list.forEach(g => {
        if (!seen.has(g.id)) {
          seen.add(g.id);
          const opt = document.createElement('option');
          opt.value = g.id;
          opt.textContent = g.name;
          select.appendChild(opt);
        }
      });
    }

    // create a card element
    function createCard(item, type) {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `
        <img src="https://image.tmdb.org/t/p/w300${item.poster_path}" alt="${item.title||item.name}" />
        <p>${item.title||item.name}</p>
      `;
      div.onclick = () => play(item.id, type);
      return div;
    }
    // filter by available
    function filterAvailable(list, type) {
      return list.filter(i => available.some(a => a.tmdb_id === i.id && a.type === type));
    }

    // fetch & render sections
    async function getTrendingMovies() {
      const el = document.getElementById('trendingMovies');
      el.innerHTML = '';
      try {
        const { results } = await (await fetch(`${PROXY_URL}trending/movie/week`)).json();
        filterAvailable(results, 'movie').slice(0,12)
          .forEach(m => el.appendChild(createCard(m,'movie')));
      } catch {
        el.innerHTML = '<p>Errore caricamento</p>';
      }
    }
    async function getTopRatedMovies() {
      const el = document.getElementById('topRatedMovies');
      el.innerHTML = '';
      try {
        const { results } = await (await fetch(`${PROXY_URL}movie/top_rated`)).json();
        filterAvailable(results, 'movie').slice(0,12)
          .forEach(m => el.appendChild(createCard(m,'movie')));
      } catch {
        el.innerHTML = '<p>Errore caricamento</p>';
      }
    }
    async function getUpcomingMovies() {
      const el = document.getElementById('upcomingMovies');
      el.innerHTML = '';
      try {
        const { results } = await (await fetch(`${PROXY_URL}movie/upcoming`)).json();
        filterAvailable(results, 'movie').slice(0,12)
          .forEach(m => el.appendChild(createCard(m,'movie')));
      } catch {
        el.innerHTML = '<p>Errore caricamento</p>';
      }
    }
    async function getPopularTv() {
      const el = document.getElementById('popularTv');
      el.innerHTML = '';
      try {
        const { results } = await (await fetch(`${PROXY_URL}tv/popular`)).json();
        filterAvailable(results, 'tv').slice(0,12)
          .forEach(tv => el.appendChild(createCard(tv,'tv')));
      } catch {
        el.innerHTML = '<p>Errore caricamento</p>';
      }
    }

    // hero: pick random from trending or popular
    async function loadHero() {
      try {
        const [mvRes, tvRes] = await Promise.all([
          fetch(`${PROXY_URL}movie/popular`),
          fetch(`${PROXY_URL}tv/popular`)
        ]);
        const movies = (await mvRes.json()).results.map(i=>({...i,media_type:'movie'}));
        const tvs    = (await tvRes.json()).results.map(i=>({...i,media_type:'tv'}));
        const pool   = [...movies,...tvs].filter(i => available.some(a=>a.tmdb_id===i.id&&a.type===i.media_type));
        if (!pool.length) return;
        const pick   = pool[Math.floor(Math.random()*pool.length)];
        heroContent  = pick;
        document.getElementById('hero-backdrop').style.backgroundImage =
          `url(https://image.tmdb.org/t/p/original${pick.backdrop_path})`;
        document.getElementById('hero-title').textContent = pick.title||pick.name;
        document.getElementById('hero-overview').textContent = pick.overview||'';
      } catch {}
    }

    // search/filter function
    async function filterMedia() {
      const title = document.getElementById('filter-title').value.trim();
      const year  = document.getElementById('filter-year').value;
      const type  = document.getElementById('filter-type').value;
      const genre = document.getElementById('filter-genre').value;
      const el    = document.getElementById('searchResults');
      el.innerHTML = '';
      if (!title && !year && type==='all' && genre==='all') return;
      try {
        const { results } = await (await fetch(`${PROXY_URL}search?q=${encodeURIComponent(title||'a')}`)).json();
        let list = results.filter(i => ['movie','tv'].includes(i.media_type));
        if (type!=='all') list = list.filter(i => i.media_type===type);
        if (year) {
          list = list.filter(i => {
            const field = i.release_date || i.first_air_date || '';
            return field.startsWith(year);
          });
        }
        if (genre!=='all') {
          const gid = parseInt(genre);
          list = list.filter(i => Array.isArray(i.genre_ids) && i.genre_ids.includes(gid));
        }
        list.filter(i => available.some(a=>a.tmdb_id===i.id&&a.type===i.media_type))
            .slice(0,20)
            .forEach(i => el.appendChild(createCard(i,i.media_type)));
      } catch {
        el.innerHTML = '<p>Errore nella ricerca</p>';
      }
    }

    // play HLS
    function play(id, type) {
      const video = document.getElementById('videoPlayer');
      const url = type==='movie'
        ? `${PROXY_URL}hls/movie/${id}`
        : `${PROXY_URL}hls/show/${id}/1/1`;
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
      } else {
        video.src = url;
      }
      video.play();
    }
    // hero play button
    document.getElementById('hero-play').onclick = () => {
      if (heroContent) play(heroContent.id, heroContent.media_type);
    };

    // init
    document.addEventListener('DOMContentLoaded', async () => {
      await Promise.all([loadAvailable(), loadGenres()]);
      populateGenres();
      await loadHero();
      getTrendingMovies();
      getTopRatedMovies();
      getUpcomingMovies();
      getPopularTv();
      document.getElementById('filter-type').onchange = populateGenres;
      document.getElementById('filter-button').onclick = filterMedia;
    });
  </script>
</body>
</html>