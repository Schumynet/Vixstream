<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>VixStream</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    .lock-scroll {
      position: fixed;
      width: 100%;
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100">

<!-- catalogo dinamico -->
<div id="catalogo"></div>

  <!-- HEADER -->
  <header class="flex items-center justify-between p-4">
    <h1 class="text-2xl font-bold">VixStream</h1>
    <div class="hidden md:flex items-center space-x-2">
      <input id="search-input"
             class="px-3 py-1 bg-gray-800 rounded focus:outline-none"
             type="text" placeholder="Cerca film o serie...">
      <button id="search-button"
              class="px-3 py-1 bg-indigo-600 rounded hover:bg-indigo-500">
        <i class="fas fa-search"></i>
      </button>
    </div>
    <div id="mobile-search-toggle" class="md:hidden p-2 cursor-pointer">
      <i class="fas fa-search"></i>
    </div>
    <div id="mobile-search-box"
         class="absolute top-16 left-0 w-full bg-gray-800 p-4 space-x-2
                transform scale-95 opacity-0 transition-all duration-200 md:hidden">
      <input id="mobile-search-input"
             class="w-4/5 px-3 py-1 bg-gray-700 rounded focus:outline-none"
             type="text" placeholder="Cerca...">
      <button id="mobile-search-button"
              class="w-1/5 px-3 py-1 bg-indigo-600 rounded hover:bg-indigo-500">
        <i class="fas fa-arrow-right"></i>
      </button>
    </div>
  </header>

  <!-- HERO -->
  <section class="relative h-[60vh] overflow-hidden">
    <div id="hero-backdrop"
         class="absolute inset-0 bg-cover bg-center transition-opacity duration-500"></div>
    <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-transparent to-gray-900"></div>
    <div class="relative z-10 p-8 max-w-2xl">
      <h2 id="hero-title" class="text-4xl font-bold mb-2">Caricamento...</h2>
      <p id="hero-overview" class="line-clamp-3 mb-4"></p>
      <div class="space-x-2">
        <button id="hero-watch"
                class="px-4 py-2 bg-red-600 rounded hover:bg-red-500">
          <i class="fas fa-play mr-2"></i>Guarda ora
        </button>
        <button id="hero-info"
                class="px-4 py-2 bg-gray-700 rounded hover:bg-gray-600">
          <i class="fas fa-info-circle mr-2"></i>Info
        </button>
      </div>
    </div>
  </section>

  <!-- MAIN SECTIONS -->
  <main class="p-4 space-y-8">
    <section>
      <h3 class="text-2xl mb-2">In Tendenza</h3>
      <div id="trendingMovies"
           class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4"></div>
    </section>

    <section>
      <h3 class="text-2xl mb-2">I Più Votati</h3>
      <div id="topRatedMovies"
           class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4"></div>
    </section>

    <section>
      <h3 class="text-2xl mb-2">Prossime Uscite</h3>
      <div id="upcomingMovies"
           class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4"></div>
    </section>

    <section>
      <h3 class="text-2xl mb-2">Serie TV Popolari</h3>
      <div id="popularTv"
           class="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4"></div>
    </section>
  </main>

  <!-- PLAYER MODAL -->
  <div id="player-modal"
       class="fixed inset-0 bg-black bg-opacity-90 hidden justify-center items-center p-4">
    <div class="relative w-full max-w-3xl">
      <button id="close-player"
              class="absolute top-2 right-2 text-white text-2xl z-10">
        <i class="fas fa-times"></i>
      </button>
      <video id="videoPlayer"
             class="w-full h-full bg-black"
             controls></video>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script>
    const PROXY_URL = 'https://vixstreamproxy.onrender.com/';
    let availableContent = [];
    let heroItem = null;
    let scrollPos = 0;

    // blocca e sblocca scroll
    function lockScroll() {
      scrollPos = window.pageYOffset;
      document.body.classList.add('lock-scroll');
      document.body.style.top = `-${scrollPos}px`;
    }
    function unlockScroll() {
      document.body.classList.remove('lock-scroll');
      document.body.style.top = '';
      window.scrollTo(0, scrollPos);
    }

    // carica catalogo disponibile
    async function loadAvailableContent() {
      try {
        const res = await fetch(`${PROXY_URL}home/available`);
        availableContent = await res.json();
      } catch {
        availableContent = [];
      }
    }

    // helper per creare card
    function createCard(item, type) {
      const div = document.createElement('div');
      div.className = 'cursor-pointer rounded overflow-hidden bg-gray-800';
      div.innerHTML = `
        <img src="https://image.tmdb.org/t/p/w300${item.poster_path}"
             class="w-full h-48 object-cover" alt="">
        <div class="p-2">
          <h4 class="font-semibold truncate">${item.title||item.name}</h4>
          <p class="text-sm text-gray-400">${
            type==='movie'
              ? (item.release_date||'').split('-')[0]
              : (item.first_air_date||'').split('-')[0]
          }</p>
        </div>`;
      div.onclick = () => playContent(item.id, type);
      return div;
    }

    // popola sezione In Tendenza
    async function getTrendingMovies() {
      const el = document.getElementById('trendingMovies');
      el.innerHTML = '';
      try {
        const { results } = await (await fetch(`${PROXY_URL}trending/movie/week`)).json();
        results
          .filter(m => availableContent.some(a => a.tmdb_id === m.id && a.type === 'movie'))
          .slice(0, 10)
          .forEach(m => el.appendChild(createCard(m, 'movie')));
      } catch {
        el.innerHTML = '<p class="text-gray-400">Errore caricamento</p>';
      }
    }

    // popola sezione Più Votati
    async function getTopRatedMovies() {
      const el = document.getElementById('topRatedMovies');
      el.innerHTML = '';
      try {
        const { results } = await (await fetch(`${PROXY_URL}movie/top_rated`)).json();
        results
          .filter(m => availableContent.some(a => a.tmdb_id === m.id && a.type === 'movie'))
          .slice(0, 10)
          .forEach(m => el.appendChild(createCard(m, 'movie')));
      } catch {
        el.innerHTML = '<p class="text-gray-400">Errore caricamento</p>';
      }
    }

    // popola sezione Prossime Uscite
    async function getUpcomingMovies() {
      const el = document.getElementById('upcomingMovies');
      el.innerHTML = '';
      try {
        const { results } = await (await fetch(`${PROXY_URL}movie/upcoming`)).json();
        results
          .filter(m => availableContent.some(a => a.tmdb_id === m.id && a.type === 'movie'))
          .slice(0, 10)
          .forEach(m => el.appendChild(createCard(m, 'movie')));
      } catch {
        el.innerHTML = '<p class="text-gray-400">Errore caricamento</p>';
      }
    }

    // popola sezione Serie TV Popolari
    async function getPopularTv() {
      const el = document.getElementById('popularTv');
      el.innerHTML = '';
      try {
        const { results } = await (await fetch(`${PROXY_URL}tv/popular`)).json();
        results
          .filter(tv => availableContent.some(a => a.tmdb_id === tv.id && a.type === 'tv'))
          .slice(0, 10)
          .forEach(tv => el.appendChild(createCard(tv, 'tv')));
      } catch {
        el.innerHTML = '<p class="text-gray-400">Errore caricamento</p>';
      }
    }

    // sceglie random hero
    async function getRandomHeroContent() {
      try {
        const [mvRes, tvRes] = await Promise.all([
          fetch(`${PROXY_URL}movie/popular`),
          fetch(`${PROXY_URL}tv/popular`)
        ]);
        const movies = (await mvRes.json()).results.map(i => ({...i, media_type:'movie'}));
        const tvs    = (await tvRes.json()).results.map(i => ({...i, media_type:'tv'}));
        const pool   = [...movies, ...tvs]
          .filter(i => availableContent.some(a => a.tmdb_id===i.id && a.type===i.media_type));
        if (!pool.length) return;
        heroItem = pool[Math.floor(Math.random()*pool.length)];
        document.getElementById('hero-backdrop').style.backgroundImage =
          `url(https://image.tmdb.org/t/p/original${heroItem.backdrop_path})`;
        document.getElementById('hero-title').textContent = heroItem.title||heroItem.name;
        document.getElementById('hero-overview').textContent = heroItem.overview||'';
      } catch {}
    }

    // riproduci contenuto
    function playContent(id, type) {
      const video = document.getElementById('videoPlayer');
      const url = type==='movie'
        ? `${PROXY_URL}hls/movie/${id}`
        : `${PROXY_URL}hls/show/${id}/1/1`;
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
      } else {
        video.src = url;
      }
      lockScroll();
      document.getElementById('player-modal').classList.remove('hidden');
      video.play();
    }

    // chiudi player
    document.getElementById('close-player').onclick = () => {
      const pm = document.getElementById('player-modal');
      const v  = document.getElementById('videoPlayer');
      v.pause(); v.src = '';
      pm.classList.add('hidden');
      unlockScroll();
    };

    // pulsanti hero
    document.getElementById('hero-watch').onclick = () => {
      if (heroItem) playContent(heroItem.id, heroItem.media_type);
    };
    document.getElementById('hero-info').onclick = () => {
      if (heroItem) alert(`${heroItem.title||heroItem.name}\n\n${heroItem.overview}`);
    };

    // init
    document.addEventListener('DOMContentLoaded', async () => {
      await loadAvailableContent();
      await getRandomHeroContent();
      getTrendingMovies();
      getTopRatedMovies();
      getUpcomingMovies();
      getPopularTv();
    });
  </script>

<!-- Script player + catalogo -->
<script src="player.js"></script>
<script src="catalog.js"></script>


</body>
</html>