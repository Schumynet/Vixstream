<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>VixStream ‚Äî Player stabile</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root{
      --bg:#000; --panel:#111; --muted:#222; --accent:#2f7bd9; --text:#fff;
      --modal-max-w:960px; --modal-pad:14px;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Arial,sans-serif}
    header{padding:10px 12px;background:var(--panel);display:flex;align-items:center;gap:12px;position:relative;z-index:10}
    .back-btn{background:transparent;border:0;color:var(--text);font-size:20px;cursor:pointer;padding:6px;border-radius:6px}
    h1{margin:0;font-size:16px;flex:1;text-align:left}
    .search-bar{display:inline-flex;align-items:center;background:var(--muted);border-radius:6px;overflow:hidden}
    .search-bar input{width:220px;padding:8px;border:0;background:transparent;color:var(--text);outline:0}
    .search-bar button{padding:8px 10px;border:0;background:var(--accent);color:var(--text);cursor:pointer}
    main{padding:12px;max-width:1200px;margin:0 auto}

    /* RESULTS */
    #results{display:flex;flex-wrap:wrap;gap:12px;justify-content:flex-start;padding:12px}
    .item{width:110px;text-align:center;cursor:pointer}
    .item img{width:100%;border-radius:6px;display:block}
    .item small{display:block;margin-top:6px;color:#a8a8a8;font-size:12px}

    /* modal/popups */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:100;align-items:center;justify-content:center;padding:20px}
    .card{background:var(--panel);width:100%;max-width:var(--modal-max-w);border-radius:10px;padding:var(--modal-pad);box-sizing:border-box;box-shadow:0 10px 30px rgba(0,0,0,0.7);display:flex;flex-direction:column;max-height:88vh;overflow:hidden}
    .card .header-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .close-btn{background:transparent;border:0;color:var(--text);font-size:18px;cursor:pointer;padding:6px;border-radius:6px}

    .detailInner{display:flex;gap:14px;align-items:flex-start}
    .detailInner img{width:160px;border-radius:6px;flex:0 0 auto}
    .detailInfo{flex:1}
    .detailInfo h2{margin:0;font-size:20px}
    .detailInfo p{color:#ddd;margin-top:8px;line-height:1.4}
    .detailActions{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}

    /* carousel small */
    .carousel{display:flex;gap:10px;overflow:auto;padding:6px}
    .cardSmall{min-width:120px;flex:0 0 auto;text-align:center;cursor:pointer}
    .cardSmall img{width:100%;border-radius:6px}
    .cardSmall .label{color:#bbb;margin-top:6px;font-size:13px}
    .cardSmall.selected{outline:2px solid var(--accent);padding:4px;border-radius:8px}

    /* ep small */
    .epSmall{min-width:120px;flex:0 0 auto;text-align:left;cursor:pointer;display:flex;flex-direction:column;gap:8px}
    .epSmall img{width:100%;border-radius:6px}
    .epSmall .epTitle{font-size:13px;color:#fff;margin-top:6px}
    .epSmall .epInfo{font-size:12px;color:#bbb}

    /* player UI */
    .playerHeader{display:flex;align-items:center;gap:10px;padding:12px;background:rgba(0,0,0,0.6);border-bottom:1px solid #111}
    .playerBack{background:rgba(0,0,0,0.6);border:0;color:var(--text);padding:6px 8px;border-radius:6px;cursor:pointer}
    .playerTitle{padding:6px 10px;border-radius:6px;font-size:16px;color:var(--text);flex:1}
    video{width:100%;display:block;background:#000}
    .center-controls{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:flex;gap:8px;background:rgba(0,0,0,0.45);padding:8px;border-radius:10px;z-index:5}
    .center-controls.hidden{opacity:0;pointer-events:none}
    .center-controls button{background:transparent;border:0;color:var(--text);font-size:20px;padding:8px;border-radius:8px;cursor:pointer}
    .bottom-controls{display:flex;flex-wrap:wrap;align-items:center;gap:8px;padding:8px;background:rgba(0,0,0,0.85);border-top:1px solid #121212}

    .btn,select,input[type=range]{background:var(--muted);color:var(--text);border:0;padding:8px;border-radius:6px;cursor:pointer}
    input[type=range]{width:140px}

    /* toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(0,0,0,0.85);color:#fff;padding:10px 14px;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.6);z-index:120;display:none}
    .toast.show{display:block;animation:toastin .28s ease}
    @keyframes toastin{from{transform:translate(-50%,12px);opacity:0}to{transform:translate(-50%,0);opacity:1}}

    @media (max-width:900px){
      .detailInner img{width:120px}
      .cardSmall{min-width:100px}
      .epSmall{min-width:100px}
    }
  </style>
</head>
<body>
  <header>
    <button class="back-btn" id="globalBack">‚Üê</button>
    <h1>VixStream</h1>
    <div class="search-bar" role="search" style="margin-left:12px">
      <input id="searchInput" placeholder="Scrivi il titolo‚Ä¶" />
      <button id="searchBtn">üîç</button>
    </div>
  </header>

  <main>
    <section id="results"></section>
  </main>

  <!-- DETAIL modal -->
  <div id="detailModal" class="modal" aria-hidden="true">
    <div class="card" role="document">
      <div class="header-row">
        <div style="font-size:18px">Dettaglio</div>
        <button id="detailClose" class="close-btn">‚úï</button>
      </div>

      <div style="overflow:auto">
        <div class="detailInner">
          <img id="detailPoster" src="" alt="poster">
          <div class="detailInfo">
            <h2 id="detailTitle">Titolo</h2>
            <div id="detailYear" style="color:#bbb;margin-top:6px"></div>
            <p id="detailOverview">Descrizione</p>
            <div class="detailActions">
              <button id="detailPlay" class="btn">‚ñ∂Ô∏è Play</button>
              <button id="detailBack" class="btn">‚Ü©Ô∏è Torna indietro</button>
            </div>
            <div style="margin-top:14px;color:#ccc;font-size:13px">
              <strong>Informazioni:</strong>
              <p id="detailMore">Generi, cast e altro.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SEASONS modal -->
  <div id="seasonsModal" class="modal" aria-hidden="true">
    <div class="card">
      <div class="header-row">
        <div style="font-size:18px">Seleziona Stagione</div>
        <button id="seasonsClose" class="close-btn">‚úï</button>
      </div>
      <div class="carousel" id="seasonsCarousel" aria-label="Stagioni"></div>
    </div>
  </div>

  <!-- EPISODES modal -->
  <div id="episodesModal" class="modal" aria-hidden="true">
    <div class="card">
      <div class="header-row">
        <div style="font-size:18px">Seleziona Episodio</div>
        <button id="episodesClose" class="close-btn">‚úï</button>
      </div>
      <div class="carousel" id="episodesCarousel" aria-label="Episodi"></div>
    </div>
  </div>

  <!-- PLAYER modal -->
  <div id="playerModal" class="modal" aria-hidden="true">
    <div class="card" style="padding:0">
      <div class="playerHeader">
        <button id="playerBack" class="playerBack">‚Üê</button>
        <div id="playerTitle" class="playerTitle">Riproduzione</div>
        <div style="width:12px"></div>
      </div>

      <div style="position:relative;background:#000">
        <video id="video" playsinline crossorigin="anonymous" preload="metadata"></video>
        <div id="centerControls" class="center-controls hidden">
          <button id="skipPrevEp">‚èÆÔ∏è</button>
          <button id="rewind">‚è™</button>
          <button id="playPause">‚ñ∂Ô∏è</button>
          <button id="forward">‚è©</button>
          <button id="skipNextEp">‚è≠Ô∏è</button>
        </div>
      </div>

      <div id="bottomControls" class="bottom-controls hidden">
        <input type="range" id="progress" min="0" max="0" value="0" />
        <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
        <button id="muteUnmute" class="btn">üîä</button>
        <input type="range" id="volume" min="0" max="1" step="0.05" value="1" />
        <select id="quality"></select>
        <select id="audio"></select>
        <select id="subtitle"></select>
        <button id="fullscreen" class="btn">‚õ∂</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status"></div>

  <script>
    // Config
    const TMDB_API_KEY = 'be78689897669066bef6906e501b0e10';
    const proxyBase = 'https://vixstreamproxy.onrender.com';

    // Helpers
    const $ = id => document.getElementById(id);
    const showModal = m => { m.style.display='flex'; m.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden'; };
    const hideModal = m => { m.style.display='none'; m.setAttribute('aria-hidden','true'); document.body.style.overflow='auto'; };
    const toastEl = $('toast');
    function showToast(msg, ms=3500){ toastEl.textContent = msg; toastEl.classList.add('show'); clearTimeout(toastEl._t); toastEl._t = setTimeout(()=>toastEl.classList.remove('show'), ms); }

    function isJSONResponse(res){ const ct = res.headers.get('content-type')||''; return ct.includes('application/json'); }
    async function safeFetchJSON(url){
      const res = await fetch(url);
      if(!res.ok){
        const t = await res.text().catch(()=>null);
        throw new Error(`HTTP ${res.status}: ${t? t.slice(0,200) : 'no body'}`);
      }
      if(!isJSONResponse(res)){
        const t = await res.text().catch(()=>null);
        throw new Error('Non-JSON: ' + (t? t.slice(0,200) : 'no body'));
      }
      return res.json();
    }
    function fmtTime(s){ if(!isFinite(s)||isNaN(s)) return '0:00'; const m=Math.floor(s/60), sec=Math.floor(s%60); return `${m}:${sec<10?'0':''}${sec}`; }

    // Elements
    const searchInput = $('searchInput'), searchBtn = $('searchBtn'), results = $('results');
    const detailModal = $('detailModal'), detailPoster = $('detailPoster'), detailTitle = $('detailTitle'), detailOverview = $('detailOverview'), detailYear = $('detailYear');
    const detailPlay = $('detailPlay'), detailBack = $('detailBack'), detailClose = $('detailClose');
    const seasonsModal = $('seasonsModal'), seasonsCarousel = $('seasonsCarousel'), seasonsClose = $('seasonsClose');
    const episodesModal = $('episodesModal'), episodesCarousel = $('episodesCarousel'), episodesClose = $('episodesClose');
    const playerModal = $('playerModal'), playerBack = $('playerBack'), playerTitle = $('playerTitle');
    const video = $('video'), centerControls = $('centerControls'), bottomControls = $('bottomControls');
    const playPause = $('playPause'), rewind = $('rewind'), forward = $('forward');
    const skipPrevEp = $('skipPrevEp'), skipNextEp = $('skipNextEp');
    const progress = $('progress'), currentTime = $('currentTime'), durationEl = $('duration');
    const muteUnmute = $('muteUnmute'), volume = $('volume');
    const quality = $('quality'), audio = $('audio'), subtitle = $('subtitle'), fullscreen = $('fullscreen');

    // State
    let selectedId=null, selectedType=null, selectedTMDB=null;
    let seasons=[], selectedSeasonIndex=0, episodes=[], selectedEpisode=null;
    let hls = null;
    let hideTimeout = null;

    // Prevent double-play (debounce)
    let playLock = false;
    function lockPlay(ms=1500){ playLock = true; setTimeout(()=>playLock=false, ms); }

    // Search & results
    async function doSearch(){
      const q = searchInput.value.trim(); if(!q) return;
      results.innerHTML = '<div style="padding:18px;color:#aaa">Ricerca in corso‚Ä¶</div>';
      try{
        const [tvRes,movieRes] = await Promise.all([
          safeFetchJSON(`https://api.themoviedb.org/3/search/tv?api_key=${TMDB_API_KEY}&language=it-IT&query=${encodeURIComponent(q)}`),
          safeFetchJSON(`https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&language=it-IT&query=${encodeURIComponent(q)}`)
        ]);
        const items = [
          ...(tvRes.results||[]).map(r=>({...r,__type:'tv'})),
          ...(movieRes.results||[]).map(r=>({...r,__type:'movie'}))
        ];
        if(!items.length){ results.innerHTML = '<div style="padding:18px;color:#aaa">Nessun risultato</div>'; return; }
        results.innerHTML = items.map(it=>`
          <div class="item" data-id="${it.id}" data-type="${it.__type}">
            <img src="${it.poster_path ? 'https://image.tmdb.org/t/p/w200'+it.poster_path : ''}" alt="">
            <small>${(it.name||it.title)||'‚Äî'} ${(it.first_air_date||it.release_date)?'('+((it.first_air_date||it.release_date)||'').slice(0,4)+')':''}</small>
          </div>
        `).join('');
      }catch(err){
        console.error(err);
        results.innerHTML = `<div style="padding:18px;color:#f66">Errore ricerca</div>`;
        showToast('Errore ricerca: ' + (err.message||''));
      }
    }
    searchBtn.addEventListener('click', doSearch);
    searchInput.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });

    // Click poster -> detail modal
    results.addEventListener('click', async ev=>{
      const el = ev.target.closest('.item'); if(!el) return;
      selectedId = el.dataset.id; selectedType = el.dataset.type;
      try{
        selectedTMDB = selectedType === 'movie'
          ? await safeFetchJSON(`https://api.themoviedb.org/3/movie/${selectedId}?api_key=${TMDB_API_KEY}&language=it-IT`)
          : await safeFetchJSON(`https://api.themoviedb.org/3/tv/${selectedId}?api_key=${TMDB_API_KEY}&language=it-IT`);
        detailPoster.src = selectedTMDB.poster_path ? 'https://image.tmdb.org/t/p/w300'+selectedTMDB.poster_path : '';
        detailTitle.textContent = selectedTMDB.title || selectedTMDB.name || 'Titolo';
        detailYear.textContent = (selectedTMDB.release_date||selectedTMDB.first_air_date||'').slice(0,4) || '';
        detailOverview.textContent = selectedTMDB.overview || '';
        showModal(detailModal);
      }catch(err){
        console.error(err);
        showToast('Errore caricamento dettagli');
      }
    });

    detailClose.addEventListener('click', ()=> hideModal(detailModal));
    detailBack.addEventListener('click', ()=> hideModal(detailModal));

    // Play from detail -> movie = play direct; tv = show seasons modal
    detailPlay.addEventListener('click', async ()=>{
      if(playLock) return;
      lockPlay();
      if(!selectedTMDB) return;
      hideModal(detailModal);
      if(selectedType === 'movie'){
        await startStreamWithChecks(`${proxyBase}/hls/movie/${selectedId}`);
        return;
      }
      // TV -> fetch seasons list and open seasons modal
      seasons = (selectedTMDB.seasons||[]).filter(s=>s.season_number>0);
      if(!seasons.length){ showToast('Nessuna stagione disponibile'); return; }
      renderSeasons();
      showModal(seasonsModal);
    });

    // Seasons carousel
    function renderSeasons(){
      seasonsCarousel.innerHTML = seasons.map((s,idx)=>`
        <div class="cardSmall" data-index="${idx}">
          <img src="${s.poster_path? 'https://image.tmdb.org/t/p/w200'+s.poster_path : ''}">
          <div class="label">S${s.season_number}</div>
        </div>
      `).join('');
      const first = seasonsCarousel.querySelector('.cardSmall');
      if(first) first.scrollIntoView({behavior:'smooth',inline:'center'});
    }
    seasonsCarousel.addEventListener('click', async ev=>{
      const c = ev.target.closest('.cardSmall'); if(!c) return;
      selectedSeasonIndex = parseInt(c.dataset.index || 0, 10);
      const sn = seasons[selectedSeasonIndex].season_number;
      try{
        const data = await safeFetchJSON(`https://api.themoviedb.org/3/tv/${selectedId}/season/${sn}?api_key=${TMDB_API_KEY}&language=it-IT`);
        episodes = data.episodes || [];
        renderEpisodes();
        hideModal(seasonsModal);
        showModal(episodesModal);
      }catch(err){
        console.error(err);
        showToast('Errore caricamento episodi');
      }
    });
    seasonsClose.addEventListener('click', ()=> hideModal(seasonsModal));

    // Episodes carousel (small cards)
    function renderEpisodes(){
      episodesCarousel.innerHTML = episodes.map((ep,idx)=>`
        <div class="epSmall" data-index="${idx}" data-episode="${ep.episode_number}">
          <img src="${ep.still_path ? 'https://image.tmdb.org/t/p/w300'+ep.still_path : ''}">
          <div class="epTitle">E${ep.episode_number} ‚Äî ${ep.name || 'Titolo'}</div>
          <div class="epInfo">${ep.air_date || ''}</div>
        </div>
      `).join('');
      const first = episodesCarousel.querySelector('.epSmall');
      if(first) first.scrollIntoView({behavior:'smooth',inline:'center'});
    }
    episodesCarousel.addEventListener('click', async ev=>{
      if(playLock) return;
      lockPlay();
      const card = ev.target.closest('.epSmall'); if(!card) return;
      const epNum = card.dataset.episode;
      const sn = seasons[selectedSeasonIndex].season_number;
      hideModal(episodesModal);
      await startStreamWithChecks(`${proxyBase}/hls/show/${selectedId}/${sn}/${epNum}`);
    });
    episodesClose.addEventListener('click', ()=> hideModal(episodesModal));

    // Start stream with pre-checks: ensure response has url before starting player
    async function startStreamWithChecks(proxyUrl){
      try{
        // fetch proxy response first (synchronous check)
        const res = await fetch(proxyUrl);
        if(!res.ok){
          const txt = await res.text().catch(()=>null);
          throw new Error(`Proxy ${res.status}: ${txt || 'no body'}`);
        }
        const ct = res.headers.get('content-type') || '';
        if(!ct.includes('application/json')){
          const txt = await res.text().catch(()=>null);
          throw new Error('Proxy non JSON: ' + (txt||''));
        }
        const data = await res.json();
        if(!data || !data.url){
          throw new Error(data && data.error ? data.error : 'Stream URL mancante');
        }
        // if we reached here, data.url exists: open player
        await openPlayer(data, proxyUrl);
      }catch(err){
        console.error(err);
        showToast('Errore stream: ' + (err.message || ''));
      }
    }

    // Open player: accept data object rather than URL string to avoid refetching
    async function openPlayer(data, proxyUrl){
      // Show player modal only after verifying data.url
      showModal(playerModal);
      playerTitle.textContent = data.title || 'Riproduzione';
      // Stop previous HLS if present
      if(hls){ try{ hls.destroy(); }catch(e){} hls = null; }
      // Prepare UI
      try{
        video.poster = data.poster || '';
      }catch(e){}
      // Init HLS
      if(Hls.isSupported()){
        hls = new Hls();
        hls.loadSource(data.url);
        hls.attachMedia(video);

        // Listen errors: non-fatal -> show toast and attempt recovery; fatal -> show toast and do not auto-close player
        hls.on(Hls.Events.ERROR, function(event, evData){
          console.warn('HLS error', evData);
          const {type, details, fatal} = evData;
          const msg = `Errore HLS (${details})`;
          showToast(msg, 5000);
          if(fatal){
            // attempt recovery for network / media errors
            if(evData.type === Hls.ErrorTypes.NETWORK_ERROR){
              // try to recover network error
              try{ hls.startLoad(); showToast('Tentativo di riconnessione...'); }catch(e){ console.warn(e); }
            } else if(evData.type === Hls.ErrorTypes.MEDIA_ERROR){
              try{ hls.recoverMediaError(); showToast('Tentativo di recupero playback'); }catch(e){ console.warn(e); }
            } else {
              // unrecoverable: notify but don't auto-close; let user close player manually
              showToast('Errore irreversibile nello stream. Premi ‚Üê per uscire.', 8000);
            }
          }
        });

        // When manifest parsed: populate quality/audio/subtitle options
        hls.on(Hls.Events.MANIFEST_PARSED, (_, info) => {
          quality.innerHTML = '<option value="-1">Auto</option>' + (info.levels||[]).map((l,i)=>`<option value="${i}">${l.height||'auto'}p</option>`).join('');
          audio.innerHTML = (info.audioTracks||[]).map((t,i)=>`<option value="${i}">${t.name||'Track '+i}</option>`).join('') || '<option disabled>Nessuna</option>';
          subtitle.innerHTML = '<option value="-1">Nessuno</option>' + ((info.subtitleTracks||[]).map((t,i)=>`<option value="${i}">${t.name||'Sub '+i}</option>`).join(''));
          video.play().catch(()=>{});
        });

      } else {
        // Native HLS
        video.src = data.url;
        video.load();
        video.play().catch(()=>{});
      }

      // UI listeners
      video.addEventListener('loadedmetadata', ()=>{ resetControls(); durationEl.textContent = fmtTime(video.duration); }, { once:true });
      video.addEventListener('timeupdate', ()=>{ currentTime.textContent = fmtTime(video.currentTime); progress.value = Math.floor(video.currentTime); }, false);
      video.addEventListener('play', ()=> { playPause.textContent='‚è∏Ô∏è'; showControls(); }, false);
      video.addEventListener('pause', ()=> { playPause.textContent='‚ñ∂Ô∏è'; showControls(); }, false);
      video.addEventListener('volumechange', ()=> { muteUnmute.textContent = (video.muted||video.volume===0)?'üîá':'üîä'; volume.value = video.volume; }, false);
    }

    // Player controls & helpers
    function resetControls(){
      playPause.textContent = video.paused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
      muteUnmute.textContent = (video.muted || video.volume === 0) ? 'üîá' : 'üîä';
      volume.value = video.volume || 1;
      currentTime.textContent = '0:00';
      durationEl.textContent = fmtTime(video.duration);
      progress.max = Math.floor(video.duration) || 0;
      progress.value = 0;
    }
    playPause.addEventListener('click', ()=>{ if(video.paused) video.play(); else video.pause(); showControls(); });
    rewind.addEventListener('click', ()=>{ video.currentTime = Math.max(0,(video.currentTime||0)-10); showControls(); });
    forward.addEventListener('click', ()=>{ video.currentTime = Math.min(video.duration||0,(video.currentTime||0)+10); showControls(); });
    progress.addEventListener('input', ()=>{ video.currentTime = progress.value; showControls(); });
    muteUnmute.addEventListener('click', ()=>{ video.muted = !video.muted; showControls(); });
    volume.addEventListener('input', ()=>{ video.volume = parseFloat(volume.value); video.muted = video.volume===0; showControls(); });
    quality.addEventListener('change', ()=>{ if(hls) hls.currentLevel = parseInt(quality.value,10); showControls(); });
    audio.addEventListener('change', ()=>{ if(hls) hls.audioTrack = parseInt(audio.value,10); showControls(); });
    subtitle.addEventListener('change', ()=>{ if(hls) hls.subtitleTrack = parseInt(subtitle.value,10); showControls(); });
    fullscreen.addEventListener('click', ()=>{ if(document.fullscreenElement) document.exitFullscreen(); else $('playerModal').requestFullscreen(); showControls(); });

    // Skip ep handlers (try to map)
    skipPrevEp.addEventListener('click', ()=>{ if(!episodes||!episodes.length) return; const idx = episodes.findIndex(e=>String(e.episode_number)===String(selectedEpisode?.episode_number)); const newIdx = Math.max(0, idx-1); const el = episodesCarousel.querySelector(`[data-index="${newIdx}"]`); if(el) el.click(); });
    skipNextEp.addEventListener('click', ()=>{ if(!episodes||!episodes.length) return; const idx = episodes.findIndex(e=>String(e.episode_number)===String(selectedEpisode?.episode_number)); const newIdx = Math.min((episodes.length-1), idx+1); const el = episodesCarousel.querySelector(`[data-index="${newIdx}"]`); if(el) el.click(); });

    // Show/hide player controls auto
    function showControls(){ centerControls.classList.remove('hidden'); bottomControls.classList.remove('hidden'); clearTimeout(hideTimeout); hideTimeout = setTimeout(()=>{ centerControls.classList.add('hidden'); bottomControls.classList.add('hidden'); }, 3000); }
    $('playerModal').addEventListener('mousemove', showControls, { passive:true });
    $('playerModal').addEventListener('touchstart', showControls, { passive:true });

    // Close player: stop hls and remove src
    playerBack.addEventListener('click', ()=>{
      if(hls){ try{ hls.destroy(); }catch(e){} hls = null; }
      try{ video.pause(); video.removeAttribute('src'); video.load(); }catch(e){}
      hideModal(playerModal);
    });

    // Close other modals
    seasonsClose.addEventListener('click', ()=> hideModal(seasonsModal));
    episodesClose.addEventListener('click', ()=> hideModal(episodesModal));
    // Clicking outside modal closes minor modals but not player
    [detailModal,seasonsModal,episodesModal].forEach(mod=>{
      mod.addEventListener('click', e=>{ if(e.target===mod) hideModal(mod); });
    });

    // Keyboard ESC closes topmost non-player modal, or player if shown
    document.addEventListener('keydown', e=>{
      if(e.key==='Escape'){
        if(playerModal.style.display==='flex'){ playerBack.click(); }
        else if(episodesModal.style.display==='flex'){ hideModal(episodesModal); }
        else if(seasonsModal.style.display==='flex'){ hideModal(seasonsModal); }
        else if(detailModal.style.display==='flex'){ hideModal(detailModal); }
      }
    });

    // initial quick sample: empty results message
    results.innerHTML = '<div style="padding:18px;color:#aaa">Cerca un titolo sopra</div>';
    // focus search input for convenience
    searchInput.focus();
  </script>
</body>
</html>