<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Player di Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    body { margin: 0; background: #000; font-family: sans-serif; color: #fff; }
    #player-container { position: relative; max-width: 960px; margin: 0 auto; overflow: hidden; }

    video {
      width: 100%;
      display: block;
      background: #000;
    }

    .center-controls,
    .timestamp-bar,
    .bottom-bar {
      position: absolute;
      left: 0; right: 0;
      display: flex;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 2;
    }

    .center-controls {
      top: 50%;
      transform: translate(-50%, -50%) translateX(50%);
      justify-content: center;
      gap: 20px;
    }
    .center-controls button {
      background: rgba(255,255,255,0.15);
      border: none; color: #fff;
      font-size: 18px; padding: 10px;
      border-radius: 50%;
    }

    .timestamp-bar {
      bottom: 60px;
      justify-content: space-between;
      padding: 0 12px;
      font-size: 14px;
      color: #fff;
    }
    .timestamp-bar #seekBar {
      flex: 1;
      margin: 0 10px;
      height: 4px;
      background: #444;
      appearance: none;
    }
    .timestamp-bar #seekBar::-webkit-slider-thumb {
      appearance: none;
      width: 12px; height: 12px;
      background: red;
      border-radius: 50%;
      cursor: pointer;
    }

    .bottom-bar {
      bottom: 0;
      justify-content: flex-end;
      padding: 8px 12px;
      background: rgba(0,0,0,0.7);
      font-size: 14px;
      gap: 8px;
    }
    .bottom-bar select,
    .bottom-bar button {
      background: rgba(255,255,255,0.1);
      border: none; color: #fff;
      padding: 4px 8px;
      border-radius: 4px;
    }

    /* Overlay ricerca */
    #searchOverlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      display: none;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      z-index: 5;
    }
    #searchOverlay input {
      width: 100%;
      max-width: 400px;
      padding: 10px;
      font-size: 16px;
      border: none;
      border-radius: 4px;
      margin-bottom: 12px;
    }
    #searchResults {
      width: 100%;
      max-width: 400px;
      overflow-y: auto;
      flex: 1;
    }
    .search-item {
      padding: 8px 12px;
      border-bottom: 1px solid #333;
      cursor: pointer;
    }
    .search-item:hover {
      background: rgba(255,255,255,0.1);
    }

    .meta {
      max-width: 960px;
      margin: 20px auto;
      font-size: 0.95em;
      line-height: 1.4;
      padding: 0 10px;
    }
  </style>
</head>
<body>

  <div id="player-container">
    <video id="video" poster="" crossorigin="anonymous"></video>

    <div class="center-controls" id="centerControls">
      <button id="prevEpisode">‚èÆ</button>
      <button id="rewind">‚è™</button>
      <button id="playPause">‚ñ∂Ô∏è</button>
      <button id="forward">‚è©</button>
      <button id="nextEpisode">‚è≠</button>
    </div>

    <div class="timestamp-bar" id="timestampBar">
      <span id="timeDisplay">00:00 / 00:00</span>
      <input type="range" id="seekBar" value="0" min="0" step="0.1">
    </div>

    <div class="bottom-bar" id="bottomBar">
      <button id="searchBtn">üîç</button>
      <select id="audio"></select>
      <select id="subtitle"></select>
      <select id="quality"></select>
      <button id="fullscreen">‚õ∂</button>
    </div>
  </div>

  <div id="searchOverlay">
    <input type="text" id="searchInput" placeholder="Cerca titolo o episodio‚Ä¶" />
    <div id="searchResults"></div>
    <button id="closeSearch" style="
      margin-top:12px;
      background:rgba(255,255,255,0.1);
      border:none;color:#fff;
      padding:6px 12px;border-radius:4px;">
      Chiudi
    </button>
  </div>

  <div class="meta" id="metaInfo">
    <strong id="metaTitle">Merlin S1:E6 Episodio 6</strong><br>
    <span id="metaDuration">Durata: 43:31</span><br>
    <span id="metaPlot">Trama: Mentre la magia ‚Ä¶</span>
  </div>

  <script>
    const video          = document.getElementById('video');
    const playPause      = document.getElementById('playPause');
    const rewindBtn      = document.getElementById('rewind');
    const forwardBtn     = document.getElementById('forward');
    const prevEp         = document.getElementById('prevEpisode');
    const nextEp         = document.getElementById('nextEpisode');
    const seekBar        = document.getElementById('seekBar');
    const timeDisplay    = document.getElementById('timeDisplay');
    const qualitySelect  = document.getElementById('quality');
    const audioSelect    = document.getElementById('audio');
    const subtitleSelect = document.getElementById('subtitle');
    const fullscreenBtn  = document.getElementById('fullscreen');
    const centerControls = document.getElementById('centerControls');
    const bottomBar      = document.getElementById('bottomBar');
    const timestampBar   = document.getElementById('timestampBar');

    const searchBtn      = document.getElementById('searchBtn');
    const closeSearch    = document.getElementById('closeSearch');
    const searchOverlay  = document.getElementById('searchOverlay');
    const searchInput    = document.getElementById('searchInput');
    const searchResults  = document.getElementById('searchResults');

    const metaTitle      = document.getElementById('metaTitle');
    const metaDuration   = document.getElementById('metaDuration');
    const metaPlot       = document.getElementById('metaPlot');

    let hideTimeout;
    function showControls() {
      [centerControls, bottomBar, timestampBar].forEach(el => el.style.opacity = '1');
      clearTimeout(hideTimeout);
      hideTimeout = setTimeout(() => {
        [centerControls, bottomBar, timestampBar].forEach(el => el.style.opacity = '0');
      }, 3000);
    }

    ['mousemove','touchstart','play','pause','seeking','seeked']
      .forEach(evt => video.addEventListener(evt, showControls));
    [centerControls, bottomBar, timestampBar].forEach(el => {
      el.addEventListener('mouseenter', () => clearTimeout(hideTimeout));
      el.addEventListener('mouseleave', showControls);
    });
    video.addEventListener('loadedmetadata', showControls);

    function formatTime(sec) {
      const m = Math.floor(sec / 60), s = Math.floor(sec % 60);
      return String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
    }

    // HLS + loadEpisode
    let hlsInstance;
    function loadEpisode(ep) {
      if (hlsInstance) hlsInstance.destroy();
      const h = new Hls();
      h.loadSource(ep.url);
      h.attachMedia(video);
      hlsInstance = h;

      video.poster = ep.poster;
      metaTitle.textContent = ep.title;
      metaDuration.textContent = 'Durata: ' + ep.duration;
      metaPlot.textContent = 'Trama: ' + ep.plot;

      h.on(Hls.Events.MANIFEST_PARSED, (_e, data) => {
        qualitySelect.innerHTML =
          '<option value="-1">Auto</option>' +
          data.levels.map((lvl, i) =>
            `<option value="${i}">${lvl.height}p</option>`
          ).join('');
      });
      h.on(Hls.Events.AUDIO_TRACKS_UPDATED, (_e, data) => {
        audioSelect.innerHTML = data.audioTracks
          .map((t, i) =>
            `<option value="${i}">${t.name || 'Track ' + i}</option>`
          ).join('');
      });
      h.on(Hls.Events.SUBTITLE_TRACKS_UPDATED, (_e, data) => {
        subtitleSelect.innerHTML =
          '<option value="-1">Nessuno</option>' +
          data.subtitleTracks.map((t, i) =>
            `<option value="${i}">${t.name || 'Sub ' + i}</option>`
          ).join('');
      });
    }

    // Caricamento iniziale di test
    loadEpisode({
      url: 'https://vixstreamproxy.onrender.com/stream?url=‚Ä¶',
      title: 'Merlin S1:E6 Episodio 6',
      poster: 'https://image.tmdb.org/t/p/w300/your-poster.jpg',
      duration: '43:31',
      plot: 'Mentre la magia si diffonde‚Ä¶'
    });

    // Controlli base
    playPause.onclick = () => {
      if (video.paused) video.play(); else video.pause();
      playPause.textContent = video.paused ? '‚ñ∂Ô∏è' : '‚è∏';
    };
    rewindBtn.onclick = () => video.currentTime = Math.max(0, video.currentTime - 10);
    forwardBtn.onclick = () => video.currentTime = Math.min(video.duration, video.currentTime + 10);
    fullscreenBtn.onclick = () => {
      if (document.fullscreenElement) document.exitFullscreen();
      else document.getElementById('player-container').requestFullscreen();
    };

    video.addEventListener('timeupdate', () => {
      seekBar.max = video.duration;
      seekBar.value = video.currentTime;
      timeDisplay.textContent = formatTime(video.currentTime) + ' / ' + formatTime(video.duration);
    });
    seekBar.oninput = () => video.currentTime = parseFloat(seekBar.value);

    // Ricerca
    searchBtn.onclick = () => { searchOverlay.style.display = 'flex'; searchInput.focus(); };
    closeSearch.onclick = () => searchOverlay.style.display = 'none';
    searchInput.onkeydown = e => {
      if (e.key === 'Enter') {
        const q = encodeURIComponent(searchInput.value.trim());
        fetch(`/api/search?query=${q}`)
          .then(r => r.json())
          .then(list => {
            searchResults.innerHTML = list.map(ep =>
              `<div class="search-item"
                    data-url="${ep.url}"
                    data-title="${ep.title}"
                    data-poster="${ep.poster}"
                    data-duration="${ep.duration}"
                    data-plot="${ep.plot}">
                 ${ep.title}
               </div>`
            ).join('');
          });
      }
    };
    searchResults.onclick = e => {
      const item = e.target.closest('.search-item');
      if (!item) return;
      const ep = {
        url: item.dataset.url,
        title: item.dataset.title,
        poster: item.dataset.poster,
        duration: item.dataset.duration,
        plot: item.dataset.plot
      };
      loadEpisode(ep);
      searchOverlay.style.display = 'none';
    };
  </script>
</body>
</html>